#!/usr/bin/env bash
# vpm v3.0 - Network Enabled
# Setup: Change REPO_URL to your actual server

# Where does Vanadium look for updates?
REPO_URL="https://gold-is-eepy-now.github.io/vanadium-repo"

DB_DIR="/var/lib/vpm/installed"
CACHE_DIR="/var/cache/vpm"
INDEX_FILE="$CACHE_DIR/index.txt"
mkdir -p "$DB_DIR" "$CACHE_DIR"

error() { echo -e "\e[31m[ERROR]\e[0m $1"; exit 1; }
msg()   { echo -e "\e[32m[VPM]\e[0m $1"; }

# --- Helper: Compare Versions ---
# Returns 0 if $1 == $2, 1 if $1 < $2 (upgrade needed), 2 if $1 > $2
ver_check() {
    [[ "$1" == "$2" ]] && return 0
    local winner=$(echo -e "$1\n$2" | sort -V | tail -n1)
    [[ "$winner" == "$2" ]] && return 1 # Update available
    return 2
}

cmd_update() {
    msg "Fetching package list from $REPO_URL..."
    if curl -sfL "$REPO_URL/index.txt" -o "$INDEX_FILE"; then
        msg "Database updated."
    else
        error "Could not reach repository."
    fi
}

cmd_create() {
    SRC="$1"; NAME="$2"
    [[ -d "$SRC" ]] || error "Source directory '$SRC' not found."
    [[ -z "$NAME" ]] && error "Package name required"

    msg "Building Vanadium Package: $NAME..."
    
    # Create metadata
    echo "NAME=$NAME" > "$SRC/PKG_INFO"
    echo "BUILD_DATE=$(date)" >> "$SRC/PKG_INFO"

    # --- CHANGED LINE BELOW ---
    # We now output .vpkg instead of .tgz
    tar -czf "$NAME.vpkg" -C "$SRC" .
    
    msg "Package created: $NAME.vpkg"
}

cmd_install() {
    INPUT="$1"
    
    # Is it a URL?
    if [[ "$INPUT" == http* ]]; then
        FILENAME=$(basename "$INPUT")
        msg "Downloading $FILENAME..."
        curl -L "$INPUT" -o "$CACHE_DIR/$FILENAME"
        PKG="$CACHE_DIR/$FILENAME"
    
    # Is it a local file?
    elif [[ -f "$INPUT" ]]; then
        PKG="$INPUT"
        
    # Is it just a name? (e.g., 'hello')
    elif grep -q "^$INPUT " "$INDEX_FILE" 2>/dev/null; then
        URL=$(grep "^$INPUT " "$INDEX_FILE" | awk '{print $3}')
        # Recursive call with the URL
        cmd_install "$URL"
        return
    else
        # Try appending extension if user forgot it
        if [[ -f "$INPUT.vpkg" ]]; then
            PKG="$INPUT.vpkg"
        else
            error "Package '$INPUT' not found."
        fi
    fi

    # ... rest of the install logic remains the same ...
    # tar -xf handles .vpkg automatically because headers are still gzip
}

# ... (Include cmd_create, cmd_remove, cmd_list from V1 here) ...

case "$1" in
    update)  cmd_update ;;
    upgrade) cmd_upgrade ;;
    install) cmd_install "$2" ;;
    create)  # (Use V1 logic, but ensure PKG_INFO has VERSION=x.x) 
             ;;
    *)       echo "Usage: vpm {update|upgrade|install|remove|create}" ;;
esac
